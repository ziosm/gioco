<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaptainCat Craft - Minecraft Style</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 50%, #90EE90 100%);
            font-family: 'Courier New', monospace;
            overflow: hidden;
            touch-action: none;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #gameCanvas {
            border: 4px solid #654321;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.8);
            z-index: 10;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #654321;
        }

        #hotbar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            z-index: 10;
            background: rgba(0,0,0,0.7);
            padding: 5px;
            border-radius: 5px;
            border: 3px solid #654321;
        }

        .hotbar-slot {
            width: 50px;
            height: 50px;
            border: 2px solid #888;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            position: relative;
        }

        .hotbar-slot.selected {
            border-color: #FFD700;
            background: rgba(255,215,0,0.3);
            box-shadow: 0 0 10px #FFD700;
        }

        .hotbar-count {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 10px;
            color: white;
            text-shadow: 1px 1px 0px black;
        }

        #controls {
            position: absolute;
            bottom: 90px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }

        .control-row {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border: 3px solid #654321;
            border-radius: 8px;
            background: rgba(139, 69, 19, 0.8);
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            transition: all 0.1s;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }

        #inventory {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(50,50,50,0.95);
            padding: 20px;
            border-radius: 10px;
            border: 4px solid #654321;
            display: none;
            z-index: 20;
            color: white;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
        }

        #inventory h2 {
            margin-bottom: 15px;
            text-align: center;
            color: #FFD700;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(4, 70px);
            gap: 10px;
            margin-bottom: 20px;
        }

        .inventory-item {
            width: 70px;
            height: 70px;
            border: 2px solid #888;
            background: rgba(100,100,100,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: pointer;
            border-radius: 5px;
        }

        .inventory-item:hover {
            border-color: #FFD700;
            background: rgba(255,215,0,0.2);
        }

        .item-count {
            font-size: 12px;
            margin-top: 5px;
        }

        #crafting {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #654321;
        }

        .craft-recipe {
            background: rgba(70,70,70,0.8);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 2px solid #555;
            cursor: pointer;
        }

        .craft-recipe:hover {
            border-color: #FFD700;
        }

        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(40,40,40,0.95);
            color: #FFD700;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 25;
            border: 4px solid #654321;
            max-width: 90vw;
        }

        #gameOver h2 {
            margin-bottom: 20px;
            font-size: 2em;
        }

        #gameOver button {
            background: #8B4513;
            color: white;
            border: 3px solid #654321;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            font-weight: bold;
        }

        #gameOver button:hover {
            background: #A0522D;
        }

        #chatContainer {
            position: absolute;
            bottom: 90px;
            left: 20px;
            width: 350px;
            max-width: calc(100vw - 40px);
            z-index: 15;
            display: none;
        }

        #chatMessages {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #654321;
            border-radius: 8px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .chat-message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .chat-system {
            color: #FFD700;
            font-style: italic;
        }

        .chat-player {
            color: #87CEEB;
        }

        .chat-server {
            color: #90EE90;
        }

        .chat-trade {
            color: #FFA500;
        }

        .chat-achievement {
            color: #FF69B4;
            font-weight: bold;
        }

        #chatInput {
            display: flex;
            gap: 5px;
        }

        #chatInput input {
            flex: 1;
            padding: 10px;
            border: 2px solid #654321;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        #chatInput button {
            padding: 10px 20px;
            border: 2px solid #654321;
            border-radius: 5px;
            background: #8B4513;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        #chatInput button:hover {
            background: #A0522D;
        }

        #chatToggle {
            position: absolute;
            bottom: 90px;
            left: 20px;
            padding: 10px 15px;
            background: rgba(139, 69, 19, 0.8);
            border: 3px solid #654321;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            z-index: 14;
            display: none;
        }

        #chatToggle:hover {
            background: rgba(160, 82, 45, 0.9);
        }

        #voiceCallButton {
            position: absolute;
            bottom: 160px;
            left: 20px;
            padding: 10px 15px;
            background: rgba(34, 139, 34, 0.8);
            border: 3px solid #2d5016;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            z-index: 14;
            display: none;
        }

        #voiceCallButton:hover {
            background: rgba(46, 184, 46, 0.9);
        }

        #voiceCallButton.active {
            background: rgba(220, 20, 60, 0.8);
            border-color: #8B0000;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        #videoCallModal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 700px;
            background: rgba(20, 20, 20, 0.95);
            border: 4px solid #654321;
            border-radius: 15px;
            padding: 20px;
            z-index: 30;
            display: none;
        }

        #videoCallModal h2 {
            color: #FFD700;
            margin-bottom: 20px;
            text-align: center;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .video-player {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #654321;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            position: relative;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .video-player.speaking {
            border-color: #00FF00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }

        .video-avatar {
            font-size: 48px;
            margin-bottom: 5px;
        }

        .video-name {
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .video-status {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            background: rgba(0, 0, 0, 0.7);
        }

        .status-muted {
            color: #FF0000;
        }

        .status-talking {
            color: #00FF00;
        }

        .voice-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .voice-btn {
            padding: 12px 20px;
            border: 2px solid #654321;
            border-radius: 8px;
            background: #8B4513;
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-btn:hover {
            background: #A0522D;
        }

        .voice-btn.muted {
            background: #DC143C;
        }

        .voice-btn.muted:hover {
            background: #FF6347;
        }

        .participants-list {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            max-height: 100px;
            overflow-y: auto;
        }

        .participant-item {
            color: white;
            padding: 5px;
            margin: 3px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .participant-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00FF00;
        }

        .participant-indicator.offline {
            background: #808080;
        }

        .chat-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 5px;
        }

        .badge-admin {
            background: #FF0000;
            color: white;
        }

        .badge-vip {
            background: #FFD700;
            color: black;
        }

        .badge-player {
            background: #4A90E2;
            color: white;
        }

        #videoCallToggle {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 12px;
            background: rgba(65, 105, 225, 0.8);
            border: 3px solid #4169E1;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            z-index: 13;
            display: none;
        }

        #videoCallToggle:hover {
            background: rgba(70, 130, 255, 0.9);
        }

        #videoCallContainer {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 220px;
            max-width: 25vw;
            background: rgba(20, 20, 20, 0.85);
            border: 3px solid #4169E1;
            border-radius: 10px;
            padding: 10px;
            display: none;
            z-index: 16;
            max-height: 60vh;
            overflow-y: auto;
        }

        #videoCallContainer h3 {
            color: #87CEEB;
            margin-bottom: 10px;
            text-align: center;
            font-size: 14px;
        }

        .video-participant {
            background: rgba(40, 40, 40, 0.8);
            border: 2px solid #555;
            border-radius: 8px;
            padding: 8px;
            margin: 8px 0;
            position: relative;
        }

        .video-preview {
            width: 100%;
            height: 80px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }

        .video-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 30%, rgba(100, 150, 255, 0.1), transparent);
            animation: videoGlow 3s ease-in-out infinite;
        }

        @keyframes videoGlow {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .participant-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-size: 11px;
        }

        .participant-name {
            font-weight: bold;
            color: #87CEEB;
            font-size: 11px;
        }

        .participant-status {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00FF00;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .audio-bars {
            display: flex;
            gap: 2px;
            align-items: flex-end;
            height: 15px;
        }

        .audio-bar {
            width: 2px;
            background: #00FF00;
            border-radius: 1px;
            animation: audioWave 0.8s ease-in-out infinite;
        }

        .audio-bar:nth-child(1) { animation-delay: 0s; height: 40%; }
        .audio-bar:nth-child(2) { animation-delay: 0.1s; height: 60%; }
        .audio-bar:nth-child(3) { animation-delay: 0.2s; height: 80%; }
        .audio-bar:nth-child(4) { animation-delay: 0.3s; height: 60%; }
        .audio-bar:nth-child(5) { animation-delay: 0.4s; height: 40%; }

        @keyframes audioWave {
            0%, 100% { transform: scaleY(0.3); }
            50% { transform: scaleY(1); }
        }

        .call-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
        }

        .call-btn {
            padding: 6px 10px;
            border: 2px solid #654321;
            border-radius: 5px;
            background: #8B4513;
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
            white-space: nowrap;
        }

        .call-btn:hover {
            background: #A0522D;
        }

        .call-btn.danger {
            background: #DC143C;
            border-color: #8B0000;
        }

        .call-btn.danger:hover {
            background: #FF0000;
        }

        .video-effect {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
            color: #FFD700;
        }

        .chat-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 5px;
        }

        .badge-admin {
            background: #FF0000;
            color: white;
        }

        .badge-vip {
            background: #FFD700;
            color: black;
        }

        .badge-player {
            background: #4A90E2;
            color: white;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .float {
            animation: float 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div class="loading" id="loading">
            <div class="float">‚õèÔ∏è</div>
            <p>Caricamento CaptainCat Craft...</p>
        </div>
        
        <canvas id="gameCanvas" width="640" height="480" style="display: none;"></canvas>
        
        <div id="ui" style="display: none;">
            <div>üê± CaptainCat Craft</div>
            <div>‚ù§Ô∏è Salute: <span id="health">10</span>/10</div>
            <div>üçó Cibo: <span id="food">10</span>/10</div>
            <div>‚≠ê Livello: <span id="level">1</span></div>
            <div>üèÜ Punti: <span id="score">0</span></div>
        </div>

        <div id="hotbar" style="display: none;">
            <div class="hotbar-slot selected" data-slot="0">
                <span id="slot0-icon">‚úã</span>
                <span class="hotbar-count" id="slot0-count"></span>
            </div>
            <div class="hotbar-slot" data-slot="1">
                <span id="slot1-icon"></span>
                <span class="hotbar-count" id="slot1-count"></span>
            </div>
            <div class="hotbar-slot" data-slot="2">
                <span id="slot2-icon"></span>
                <span class="hotbar-count" id="slot2-count"></span>
            </div>
            <div class="hotbar-slot" data-slot="3">
                <span id="slot3-icon"></span>
                <span class="hotbar-count" id="slot3-count"></span>
            </div>
            <div class="hotbar-slot" data-slot="4">
                <span id="slot4-icon"></span>
                <span class="hotbar-count" id="slot4-count"></span>
            </div>
        </div>

        <div id="controls" style="display: none;">
            <div class="control-row">
                <button class="control-btn" id="jumpBtn">‚Üë</button>
            </div>
            <div class="control-row">
                <button class="control-btn" id="leftBtn">‚Üê</button>
                <button class="control-btn" id="invBtn">üì¶</button>
                <button class="control-btn" id="rightBtn">‚Üí</button>
            </div>
        </div>

        <button id="chatToggle" onclick="toggleChat()">üí¨ Chat</button>
        <button id="videoCallToggle" onclick="toggleVideoCall()">üìπ Videochiamata</button>

        <div id="chatContainer">
            <div id="chatMessages"></div>
            <div id="chatInput">
                <input type="text" id="chatInputField" placeholder="Scrivi un messaggio..." maxlength="100" />
                <button onclick="sendMessage()">üì§</button>
            </div>
        </div>

        <div id="videoCallContainer">
            <h3>üìπ Videochiamata di Squadra</h3>
            <div id="participantsList"></div>
            <div class="call-controls">
                <button class="call-btn" onclick="toggleMute()">üé§ Mute/Unmute</button>
                <button class="call-btn" onclick="toggleVideo()">üìπ Video On/Off</button>
                <button class="call-btn danger" onclick="leaveCall()">üìû Esci</button>
            </div>
        </div>

        <div id="inventory">
            <h2>üì¶ Inventario & Crafting</h2>
            <div class="inventory-grid" id="inventoryGrid"></div>
            <div id="crafting">
                <h3>üî® Crafting</h3>
                <div id="craftingRecipes"></div>
            </div>
            <button onclick="closeInventory()" style="margin-top: 20px; width: 100%; padding: 15px; background: #8B4513; border: 3px solid #654321; border-radius: 8px; color: white; font-size: 16px; cursor: pointer;">Chiudi</button>
        </div>

        <div id="gameOver">
            <h2>üéÆ Game Over! üéÆ</h2>
            <p><strong>Punti Finali:</strong> <span id="finalScore">0</span></p>
            <p><strong>Livello Raggiunto:</strong> <span id="finalLevel">1</span></p>
            <p><strong>Blocchi Minati:</strong> <span id="finalBlocks">0</span></p>
            <p><strong>Oggetti Craftati:</strong> <span id="finalCrafted">0</span></p>
            <button onclick="restartGame()">üîÑ Gioca Ancora</button>
            <button onclick="submitScore()">üìä Salva Punteggio</button>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const BLOCK_SIZE = 32;
        const WORLD_WIDTH = 40;
        const WORLD_HEIGHT = 30;
        
        let gameState = {
            score: 0,
            level: 1,
            health: 10,
            food: 10,
            blocksMined: 0,
            itemsCrafted: 0,
            gameRunning: false,
            startTime: Date.now(),
            selectedSlot: 0,
            showInventory: false
        };

        const player = {
            x: 10,
            y: 10,
            velocityX: 0,
            velocityY: 0,
            speed: 4,
            jumpPower: 12,
            onGround: false,
            direction: 1,
            mining: false,
            miningProgress: 0,
            targetBlock: null
        };

        const BLOCKS = {
            AIR: { id: 0, icon: '', solid: false, breakTime: 0 },
            GRASS: { id: 1, icon: 'üü©', solid: true, breakTime: 20, drops: 'DIRT' },
            DIRT: { id: 2, icon: 'üü´', solid: true, breakTime: 15, drops: 'DIRT' },
            STONE: { id: 3, icon: '‚¨ú', solid: true, breakTime: 40, drops: 'COBBLESTONE' },
            WOOD: { id: 4, icon: 'üü§', solid: true, breakTime: 30, drops: 'WOOD' },
            LEAVES: { id: 5, icon: 'üåø', solid: false, breakTime: 10, drops: null },
            COAL: { id: 6, icon: '‚ö´', solid: true, breakTime: 50, drops: 'COAL' },
            IRON: { id: 7, icon: 'üî≥', solid: true, breakTime: 60, drops: 'IRON_ORE' },
            GOLD: { id: 8, icon: 'üü®', solid: true, breakTime: 70, drops: 'GOLD_ORE' },
            DIAMOND: { id: 9, icon: 'üíé', solid: true, breakTime: 100, drops: 'DIAMOND' },
            WATER: { id: 10, icon: 'üíß', solid: false, breakTime: 0 },
            LAVA: { id: 11, icon: 'üî•', solid: false, breakTime: 0 }
        };

        const ITEMS = {
            DIRT: { icon: 'üü´', stackable: true, placeable: 'DIRT' },
            COBBLESTONE: { icon: '‚¨ú', stackable: true, placeable: 'STONE' },
            WOOD: { icon: 'üü§', stackable: true, placeable: 'WOOD' },
            COAL: { icon: '‚ö´', stackable: true },
            IRON_ORE: { icon: 'üî≥', stackable: true },
            GOLD_ORE: { icon: 'üü®', stackable: true },
            DIAMOND: { icon: 'üíé', stackable: true },
            PICKAXE: { icon: '‚õèÔ∏è', stackable: false, tool: true, power: 2 },
            SWORD: { icon: 'üó°Ô∏è', stackable: false, weapon: true, power: 3 },
            AXE: { icon: 'ü™ì', stackable: false, tool: true, power: 2 },
            FOOD: { icon: 'üçó', stackable: true, edible: true, hunger: 3 }
        };

        const RECIPES = [
            { name: 'Piccone', requires: { WOOD: 3, COBBLESTONE: 3 }, produces: 'PICKAXE' },
            { name: 'Ascia', requires: { WOOD: 3, COBBLESTONE: 3 }, produces: 'AXE' },
            { name: 'Spada', requires: { WOOD: 1, COBBLESTONE: 2 }, produces: 'SWORD' },
            { name: 'Cibo', requires: { COAL: 1, WOOD: 2 }, produces: 'FOOD' }
        ];

        let world = [];
        let inventory = {
            DIRT: 0,
            WOOD: 0,
            COBBLESTONE: 0,
            COAL: 0,
            IRON_ORE: 0,
            GOLD_ORE: 0,
            DIAMOND: 0,
            PICKAXE: 0,
            SWORD: 0,
            AXE: 0,
            FOOD: 5
        };

        let hotbar = ['HAND', 'PICKAXE', 'SWORD', 'DIRT', 'FOOD'];
        let camera = { x: 0, y: 0 };
        const keys = {};
        let touchControls = { left: false, right: false, jump: false };

        // Chat system
        let chatMessages = [];
        let chatOpen = false;
        let lastChatTime = 0;
        const playerName = 'CaptainCat_' + Math.floor(Math.random() * 1000);
        
        // Video call system
        let videoCallOpen = false;
        let isMuted = false;
        let isVideoOn = true;
        let participants = [];
        
        const NPC_PLAYERS = [
            { name: 'SteveBuilder', type: 'player', messages: ['Qualcuno ha del ferro?', 'Sto costruendo una casa!', 'Chi vuole fare team?'] },
            { name: 'DiamondHunter', type: 'vip', messages: ['Ho trovato diamanti! üíé', 'Livello 45 raggiunto!', 'Vendo picconi enchantati'] },
            { name: 'NoobMiner', type: 'player', messages: ['Come si fa il crafting?', 'Help! Sono perso nella miniera', 'Qualcuno mi pu√≤ dare del cibo?'] },
            { name: 'ProGamer', type: 'vip', messages: ['GG ez', 'Record mondiale! üèÜ', 'Chi vuole duellare?'] },
            { name: 'Admin_Cat', type: 'admin', messages: ['Benvenuti nel server!', 'Rispettate le regole', 'Evento speciale tra 5 minuti!'] }
        ];

        function generateWorld() {
            world = [];
            for (let y = 0; y < WORLD_HEIGHT; y++) {
                world[y] = [];
                for (let x = 0; x < WORLD_WIDTH; x++) {
                    if (y < 8) {
                        world[y][x] = BLOCKS.AIR;
                    } else if (y === 8) {
                        world[y][x] = BLOCKS.GRASS;
                    } else if (y < 13) {
                        world[y][x] = BLOCKS.DIRT;
                    } else if (y < 25) {
                        // Stone layer with ores
                        const rand = Math.random();
                        if (rand < 0.02) world[y][x] = BLOCKS.DIAMOND;
                        else if (rand < 0.05) world[y][x] = BLOCKS.GOLD;
                        else if (rand < 0.10) world[y][x] = BLOCKS.IRON;
                        else if (rand < 0.20) world[y][x] = BLOCKS.COAL;
                        else world[y][x] = BLOCKS.STONE;
                    } else {
                        world[y][x] = BLOCKS.LAVA;
                    }
                }
            }

            // Add trees
            for (let i = 0; i < 8; i++) {
                let tx = Math.floor(Math.random() * (WORLD_WIDTH - 2)) + 1;
                for (let ty = 5; ty < 8; ty++) {
                    world[ty][tx] = BLOCKS.WOOD;
                }
                for (let ty = 3; ty < 6; ty++) {
                    world[ty][tx - 1] = BLOCKS.LEAVES;
                    world[ty][tx] = BLOCKS.LEAVES;
                    world[ty][tx + 1] = BLOCKS.LEAVES;
                }
            }

            // Add some water
            for (let x = 30; x < 35; x++) {
                world[8][x] = BLOCKS.WATER;
            }
        }

        function initGame() {
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('gameCanvas').style.display = 'block';
                document.getElementById('ui').style.display = 'block';
                document.getElementById('hotbar').style.display = 'flex';
                document.getElementById('controls').style.display = 'flex';
                document.getElementById('chatToggle').style.display = 'block';
                document.getElementById('videoCallToggle').style.display = 'block';
                
                generateWorld();
                setupEventListeners();
                updateHotbar();
                initChat();
                gameState.gameRunning = true;
                gameLoop();
            }, 2000);
        }

        function setupEventListeners() {
            document.addEventListener('keydown', (e) => {
                keys[e.code] = true;
                if (e.code === 'KeyE') toggleInventory();
                if (e.code >= 'Digit1' && e.code <= 'Digit5') {
                    gameState.selectedSlot = parseInt(e.code[5]) - 1;
                    updateHotbar();
                }
                if (e.code === 'Space') {
                    e.preventDefault();
                    if (player.onGround) {
                        player.velocityY = -player.jumpPower;
                        player.onGround = false;
                    }
                }
            });

            document.addEventListener('keyup', (e) => {
                keys[e.code] = false;
            });

            canvas.addEventListener('click', (e) => {
                const rect = canvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                
                const worldX = Math.floor((clickX + camera.x) / BLOCK_SIZE);
                const worldY = Math.floor((clickY + camera.y) / BLOCK_SIZE);
                
                handleBlockInteraction(worldX, worldY);
            });

            const setupTouchButton = (btnId, control) => {
                const btn = document.getElementById(btnId);
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (control === 'inventory') {
                        toggleInventory();
                    } else if (control === 'jump') {
                        if (player.onGround) {
                            player.velocityY = -player.jumpPower;
                            player.onGround = false;
                        }
                    } else {
                        touchControls[control] = true;
                    }
                });
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    if (control !== 'inventory' && control !== 'jump') {
                        touchControls[control] = false;
                    }
                });
            };

            setupTouchButton('leftBtn', 'left');
            setupTouchButton('rightBtn', 'right');
            setupTouchButton('jumpBtn', 'jump');
            setupTouchButton('invBtn', 'inventory');

            document.querySelectorAll('.hotbar-slot').forEach((slot, index) => {
                slot.addEventListener('click', () => {
                    gameState.selectedSlot = index;
                    updateHotbar();
                });
            });
        }

        function handleBlockInteraction(worldX, worldY) {
            if (worldX < 0 || worldX >= WORLD_WIDTH || worldY < 0 || worldY >= WORLD_HEIGHT) return;
            
            const block = world[worldY][worldX];
            const playerDist = Math.abs(player.x - worldX) + Math.abs(player.y - worldY);
            
            if (playerDist > 3) return;
            
            const selectedItem = hotbar[gameState.selectedSlot];
            
            if (block.id !== BLOCKS.AIR.id) {
                // Mine block
                mineBlock(worldX, worldY);
            } else if (selectedItem && selectedItem !== 'HAND' && ITEMS[selectedItem]?.placeable) {
                // Place block
                if (inventory[selectedItem] > 0) {
                    world[worldY][worldX] = BLOCKS[ITEMS[selectedItem].placeable];
                    inventory[selectedItem]--;
                    updateHotbar();
                    gameState.score += 5;
                }
            }
        }

        function mineBlock(x, y) {
            const block = world[y][x];
            if (!block.solid && block.id !== BLOCKS.WATER.id) return;
            
            const selectedItem = hotbar[gameState.selectedSlot];
            const hasTool = selectedItem && ITEMS[selectedItem]?.tool;
            const breakTime = hasTool ? Math.floor(block.breakTime / 2) : block.breakTime;
            
            if (player.targetBlock?.x === x && player.targetBlock?.y === y) {
                player.miningProgress++;
                
                if (player.miningProgress >= breakTime) {
                    world[y][x] = BLOCKS.AIR;
                    if (block.drops) {
                        inventory[block.drops] = (inventory[block.drops] || 0) + 1;
                        gameState.score += 10;
                    }
                    gameState.blocksMined++;
                    player.miningProgress = 0;
                    player.targetBlock = null;
                    updateHotbar();
                }
            } else {
                player.targetBlock = { x, y };
                player.miningProgress = 0;
            }
        }

        function update() {
            if (!gameState.gameRunning) return;

            handleInput();
            updatePlayer();
            updateCamera();
            updateUI();
            checkSurvival();
        }

        function handleInput() {
            if (keys['KeyA'] || keys['ArrowLeft'] || touchControls.left) {
                player.velocityX = -player.speed;
                player.direction = -1;
            } else if (keys['KeyD'] || keys['ArrowRight'] || touchControls.right) {
                player.velocityX = player.speed;
                player.direction = 1;
            } else {
                player.velocityX *= 0.7;
            }
        }

        function updatePlayer() {
            // Gravity
            player.velocityY += 0.8;
            if (player.velocityY > 15) player.velocityY = 15;
            
            // Move
            player.x += player.velocityX / BLOCK_SIZE;
            player.y += player.velocityY / BLOCK_SIZE;
            
            player.onGround = false;
            
            // Collision
            const blockX = Math.floor(player.x);
            const blockY = Math.floor(player.y + 1);
            
            if (blockY < WORLD_HEIGHT && world[blockY]?.[blockX]?.solid) {
                player.y = blockY - 1;
                player.velocityY = 0;
                player.onGround = true;
            }
            
            // Bounds
            if (player.x < 0) player.x = 0;
            if (player.x >= WORLD_WIDTH - 1) player.x = WORLD_WIDTH - 1;
            if (player.y < 0) player.y = 0;
            
            // Damage from lava
            if (blockY < WORLD_HEIGHT && world[blockY]?.[blockX]?.id === BLOCKS.LAVA.id) {
                gameState.health -= 0.1;
            }
            
            // Hunger
            if (Math.random() < 0.001) {
                gameState.food = Math.max(0, gameState.food - 0.1);
            }
            
            if (gameState.food < 3) {
                gameState.health = Math.max(0, gameState.health - 0.01);
            }
        }

        function updateCamera() {
            camera.x = (player.x * BLOCK_SIZE) - canvas.width / 2 + BLOCK_SIZE / 2;
            camera.y = (player.y * BLOCK_SIZE) - canvas.height / 2 + BLOCK_SIZE / 2;
            
            camera.x = Math.max(0, Math.min(camera.x, WORLD_WIDTH * BLOCK_SIZE - canvas.width));
            camera.y = Math.max(0, Math.min(camera.y, WORLD_HEIGHT * BLOCK_SIZE - canvas.height));
        }

        function updateUI() {
            document.getElementById('health').textContent = Math.ceil(gameState.health);
            document.getElementById('food').textContent = Math.ceil(gameState.food);
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('score').textContent = gameState.score;
        }

        function checkSurvival() {
            if (gameState.health <= 0) {
                gameOver();
            }
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw sky gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(1, '#E0F6FF');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw world
            for (let y = 0; y < WORLD_HEIGHT; y++) {
                for (let x = 0; x < WORLD_WIDTH; x++) {
                    const block = world[y][x];
                    if (!block || block.id === BLOCKS.AIR.id) continue;
                    
                    const screenX = x * BLOCK_SIZE - camera.x;
                    const screenY = y * BLOCK_SIZE - camera.y;
                    
                    if (screenX < -BLOCK_SIZE || screenX > canvas.width || screenY < -BLOCK_SIZE || screenY > canvas.height) continue;
                    
                    ctx.font = `${BLOCK_SIZE}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(block.icon, screenX + BLOCK_SIZE / 2, screenY + BLOCK_SIZE / 2);
                    
                    // Mining progress
                    if (player.targetBlock?.x === x && player.targetBlock?.y === y && player.miningProgress > 0) {
                        ctx.strokeStyle = 'red';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(screenX, screenY, BLOCK_SIZE, BLOCK_SIZE);
                    }
                }
            }
            
            // Draw player
            const playerScreenX = player.x * BLOCK_SIZE - camera.x;
            const playerScreenY = player.y * BLOCK_SIZE - camera.y;
            
            ctx.font = '32px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('üê±', playerScreenX + BLOCK_SIZE / 2, playerScreenY + BLOCK_SIZE / 2);
        }

        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }

        function updateHotbar() {
            for (let i = 0; i < 5; i++) {
                const slot = document.querySelector(`[data-slot="${i}"]`);
                const item = hotbar[i];
                const icon = document.getElementById(`slot${i}-icon`);
                const count = document.getElementById(`slot${i}-count`);
                
                if (item === 'HAND') {
                    icon.textContent = '‚úã';
                    count.textContent = '';
                } else if (ITEMS[item]) {
                    icon.textContent = ITEMS[item].icon;
                    count.textContent = inventory[item] > 0 ? inventory[item] : '';
                } else {
                    icon.textContent = '';
                    count.textContent = '';
                }
                
                slot.classList.toggle('selected', i === gameState.selectedSlot);
            }
        }

        function toggleInventory() {
            gameState.showInventory = !gameState.showInventory;
            document.getElementById('inventory').style.display = gameState.showInventory ? 'block' : 'none';
            
            if (gameState.showInventory) {
                updateInventoryDisplay();
            }
        }

        function closeInventory() {
            gameState.showInventory = false;
            document.getElementById('inventory').style.display = 'none';
        }

        function updateInventoryDisplay() {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = '';
            
            for (const [itemName, count] of Object.entries(inventory)) {
                if (count > 0) {
                    const item = document.createElement('div');
                    item.className = 'inventory-item';
                    item.innerHTML = `
                        <div style="font-size: 30px;">${ITEMS[itemName].icon}</div>
                        <div class="item-count">${count}</div>
                    `;
                    grid.appendChild(item);
                }
            }
            
            const recipes = document.getElementById('craftingRecipes');
            recipes.innerHTML = '';
            
            RECIPES.forEach(recipe => {
                const canCraft = Object.entries(recipe.requires).every(([item, amount]) => inventory[item] >= amount);
                
                const div = document.createElement('div');
                div.className = 'craft-recipe';
                div.style.opacity = canCraft ? '1' : '0.5';
                
                const reqText = Object.entries(recipe.requires).map(([item, amount]) => 
                    `${ITEMS[item].icon}√ó${amount}`
                ).join(' + ');
                
                div.innerHTML = `
                    <strong>${recipe.name}</strong><br>
                    ${reqText} ‚Üí ${ITEMS[recipe.produces].icon}
                `;
                
                if (canCraft) {
                    div.onclick = () => craftItem(recipe);
                }
                
                recipes.appendChild(div);
            });
        }

        function craftItem(recipe) {
            for (const [item, amount] of Object.entries(recipe.requires)) {
                inventory[item] -= amount;
            }
            inventory[recipe.produces] = (inventory[recipe.produces] || 0) + 1;
            gameState.itemsCrafted++;
            gameState.score += 50;
            
            updateInventoryDisplay();
            updateHotbar();
        }

        function eatFood() {
            const selectedItem = hotbar[gameState.selectedSlot];
            if (selectedItem === 'FOOD' && inventory.FOOD > 0) {
                inventory.FOOD--;
                gameState.food = Math.min(10, gameState.food + 3);
                updateHotbar();
            }
        }

        function gameOver() {
            gameState.gameRunning = false;
            
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('finalLevel').textContent = gameState.level;
            document.getElementById('finalBlocks').textContent = gameState.blocksMined;
            document.getElementById('finalCrafted').textContent = gameState.itemsCrafted;
            document.getElementById('gameOver').style.display = 'block';
        }

        function restartGame() {
            gameState = {
                score: 0,
                level: 1,
                health: 10,
                food: 10,
                blocksMined: 0,
                itemsCrafted: 0,
                gameRunning: true,
                startTime: Date.now(),
                selectedSlot: 0,
                showInventory: false
            };
            
            player.x = 10;
            player.y = 10;
            player.velocityX = 0;
            player.velocityY = 0;
            player.onGround = false;
            
            inventory = {
                DIRT: 0,
                WOOD: 0,
                COBBLESTONE: 0,
                COAL: 0,
                IRON_ORE: 0,
                GOLD_ORE: 0,
                DIAMOND: 0,
                PICKAXE: 1,
                SWORD: 0,
                AXE: 0,
                FOOD: 5
            };
            
            generateWorld();
            updateHotbar();
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('inventory').style.display = 'none';
        }

        function submitScore() {
            const playTime = Math.floor((Date.now() - gameState.startTime) / 1000);
            
            const gameResults = {
                score: gameState.score,
                level: gameState.level,
                blocksMined: gameState.blocksMined,
                itemsCrafted: gameState.itemsCrafted,
                playTime: playTime
            };
            
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.sendData(JSON.stringify(gameResults));
                window.Telegram.WebApp.close();
            } else {
                alert(`üèÜ Punteggio salvato!\n\nPunti: ${gameState.score}\nBlocchi minati: ${gameState.blocksMined}\nOggetti craftati: ${gameState.itemsCrafted}`);
            }
        }

        // Initialize Telegram Web App
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }

        // Key for eating
        document.addEventListener('keydown', (e) => {
            if (e.code === 'KeyF') eatFood();
        });

        // ===== CHAT SYSTEM =====
        function initChat() {
            addChatMessage('system', 'üåü Benvenuto in CaptainCat Craft!');
            addChatMessage('system', `üìõ Il tuo nome: ${playerName}`);
            addChatMessage('server', 'üí¨ Premi T per aprire la chat');
            addChatMessage('server', 'üìπ Premi V per la videochiamata');
            
            // Simulate other players joining
            setTimeout(() => {
                const randomPlayer = NPC_PLAYERS[Math.floor(Math.random() * NPC_PLAYERS.length)];
                addChatMessage('system', `‚ûï ${randomPlayer.name} si √® unito al server!`);
            }, 5000);
            
            // Random NPC messages
            setInterval(() => {
                if (Math.random() < 0.3) {
                    const npc = NPC_PLAYERS[Math.floor(Math.random() * NPC_PLAYERS.length)];
                    const message = npc.messages[Math.floor(Math.random() * npc.messages.length)];
                    addChatMessage(npc.type, `${npc.name}: ${message}`);
                }
            }, 15000);
        }

        function addChatMessage(type, text) {
            chatMessages.push({ type, text, time: Date.now() });
            if (chatMessages.length > 50) chatMessages.shift();
            
            const messagesDiv = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message chat-${type}`;
            
            if (type === 'player' || type === 'vip' || type === 'admin') {
                const badge = type === 'admin' ? 'badge-admin' : type === 'vip' ? 'badge-vip' : 'badge-player';
                const badgeText = type === 'admin' ? 'ADMIN' : type === 'vip' ? 'VIP' : 'PLAYER';
                msgDiv.innerHTML = `<span class="chat-badge ${badge}">${badgeText}</span>${text}`;
            } else {
                msgDiv.textContent = text;
            }
            
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function toggleChat() {
            chatOpen = !chatOpen;
            document.getElementById('chatContainer').style.display = chatOpen ? 'block' : 'none';
            if (chatOpen) {
                document.getElementById('chatInputField').focus();
            }
        }

        function sendMessage() {
            const input = document.getElementById('chatInputField');
            const text = input.value.trim();
            
            if (text.length === 0) return;
            
            addChatMessage('player', `${playerName}: ${text}`);
            input.value = '';
            
            // Simulate responses
            setTimeout(() => {
                const responses = [
                    'Bella!', 'GG!', 'Interessante!', 'Sono d\'accordo', 
                    'LOL üòÇ', 'Ottima idea!', 'Chi vuole fare team?', 'Qualcuno mi aiuta?'
                ];
                const npc = NPC_PLAYERS[Math.floor(Math.random() * NPC_PLAYERS.length)];
                const response = responses[Math.floor(Math.random() * responses.length)];
                addChatMessage(npc.type, `${npc.name}: ${response}`);
            }, 2000 + Math.random() * 3000);
        }

        document.addEventListener('keydown', (e) => {
            if (e.code === 'KeyT' && !chatOpen) {
                e.preventDefault();
                toggleChat();
            } else if (e.code === 'Enter' && chatOpen) {
                e.preventDefault();
                sendMessage();
            } else if (e.code === 'Escape' && chatOpen) {
                toggleChat();
            }
        });

        // ===== VIDEO CALL SYSTEM =====
        function initVideoCall() {
            // Create participants (3-5 random players)
            const numParticipants = 3 + Math.floor(Math.random() * 3);
            participants = [];
            
            for (let i = 0; i < numParticipants; i++) {
                const npc = NPC_PLAYERS[Math.floor(Math.random() * NPC_PLAYERS.length)];
                if (!participants.find(p => p.name === npc.name)) {
                    participants.push({
                        name: npc.name,
                        type: npc.type,
                        avatar: getRandomAvatar(),
                        speaking: false,
                        videoOn: true
                    });
                }
            }
            
            // Add yourself
            participants.unshift({
                name: playerName + ' (Tu)',
                type: 'player',
                avatar: 'üê±',
                speaking: false,
                videoOn: isVideoOn
            });
            
            updateParticipantsList();
            
            // Simulate random speaking
            setInterval(() => {
                if (videoCallOpen) {
                    participants.forEach((p, i) => {
                        if (i !== 0) { // Not yourself
                            p.speaking = Math.random() < 0.2;
                        }
                    });
                    updateParticipantsList();
                }
            }, 2000);
        }

        function getRandomAvatar() {
            const avatars = ['üë®', 'üë©', 'üßë', 'üë¥', 'üëµ', 'üßî', 'üë®‚Äçü¶∞', 'üë©‚Äçü¶∞', 'üë®‚Äçü¶±', 'üë©‚Äçü¶±', 'ü¶∏', 'üßô'];
            return avatars[Math.floor(Math.random() * avatars.length)];
        }

        function toggleVideoCall() {
            videoCallOpen = !videoCallOpen;
            document.getElementById('videoCallContainer').style.display = videoCallOpen ? 'block' : 'none';
            
            if (videoCallOpen && participants.length === 0) {
                initVideoCall();
                addChatMessage('system', 'üìπ Sei entrato nella videochiamata di squadra!');
            }
        }

        function updateParticipantsList() {
            const container = document.getElementById('participantsList');
            container.innerHTML = '';
            
            participants.forEach((participant, index) => {
                const div = document.createElement('div');
                div.className = 'video-participant';
                
                const videoQuality = ['HD 1080p', '4K', '720p', 'HD'][Math.floor(Math.random() * 4)];
                
                div.innerHTML = `
                    <div class="video-preview">
                        <div style="font-size: 60px; z-index: 1;">${participant.avatar}</div>
                        ${participant.videoOn ? `<div class="video-effect">${videoQuality}</div>` : ''}
                        ${!participant.videoOn ? '<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; color: white; font-size: 16px;">üìπ Video Off</div>' : ''}
                    </div>
                    <div class="participant-info">
                        <div>
                            <div class="participant-name">${participant.name}</div>
                            <small style="color: #888;">${participant.type === 'admin' ? 'üëë Admin' : participant.type === 'vip' ? '‚≠ê VIP' : 'üë§ Player'}</small>
                        </div>
                        <div class="participant-status">
                            <div class="status-indicator"></div>
                            ${participant.speaking ? `
                                <div class="audio-bars">
                                    <div class="audio-bar"></div>
                                    <div class="audio-bar"></div>
                                    <div class="audio-bar"></div>
                                    <div class="audio-bar"></div>
                                    <div class="audio-bar"></div>
                                </div>
                            ` : '<span style="font-size: 11px; color: #888;">üîá</span>'}
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function toggleMute() {
            isMuted = !isMuted;
            if (participants.length > 0) {
                participants[0].speaking = !isMuted;
            }
            addChatMessage('system', isMuted ? 'üîá Microfono disattivato' : 'üé§ Microfono attivato');
        }

        function toggleVideo() {
            isVideoOn = !isVideoOn;
            if (participants.length > 0) {
                participants[0].videoOn = isVideoOn;
                updateParticipantsList();
            }
            addChatMessage('system', isVideoOn ? 'üìπ Video attivato' : 'üìπ Video disattivato');
        }

        function leaveCall() {
            videoCallOpen = false;
            document.getElementById('videoCallContainer').style.display = 'none';
            addChatMessage('system', 'üëã Hai lasciato la videochiamata');
            participants = [];
        }

        function shareScreen() {
            addChatMessage('system', 'üñ•Ô∏è Condivisione schermo attivata');
            addChatMessage('server', 'üì¢ ' + playerName + ' sta condividendo lo schermo!');
        }

        // Simulate random voice activity
        setInterval(() => {
            if (videoCallOpen && participants.length > 1) {
                const randomParticipant = participants[Math.floor(Math.random() * (participants.length - 1)) + 1];
                randomParticipant.speaking = Math.random() > 0.7;
                if (randomParticipant.speaking) {
                    setTimeout(() => {
                        randomParticipant.speaking = false;
                    }, 1500);
                }
            }
        }, 3000);

        // Simulate players joining/leaving
        setInterval(() => {
            if (videoCallOpen && Math.random() > 0.8) {
                if (participants.length < 6 && Math.random() > 0.5) {
                    // Someone joins
                    const randomPlayer = NPC_PLAYERS[Math.floor(Math.random() * NPC_PLAYERS.length)];
                    const exists = participants.find(p => p.name === randomPlayer.name);
                    if (!exists) {
                        participants.push({
                            name: randomPlayer.name,
                            avatar: getRandomAvatar(),
                            speaking: false,
                            muted: Math.random() > 0.7,
                            videoOn: Math.random() > 0.5
                        });
                        addChatMessage('system', '‚úÖ ' + randomPlayer.name + ' √® entrato nella chiamata');
                    }
                } else if (participants.length > 2) {
                    // Someone leaves
                    const randomIndex = Math.floor(Math.random() * (participants.length - 1)) + 1;
                    const leavingPlayer = participants[randomIndex];
                    participants.splice(randomIndex, 1);
                    addChatMessage('system', 'üëã ' + leavingPlayer.name + ' ha lasciato la chiamata');
                }
                updateParticipantsList();
            }
        }, 15000);

        // Quick access keys
        document.addEventListener('keydown', (e) => {
            if (e.code === 'KeyM' && videoCallOpen) {
                e.preventDefault();
                toggleMute();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.code === 'KeyV' && !videoCallOpen) {
                e.preventDefault();
                toggleVideoCall();
            }
        });

        initGame();
    </script>
</body>
</html>
